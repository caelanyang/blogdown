<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Android Thread，Handler 和 Looper - Jia Cheng</title>
    <meta property="og:title" content="Android Thread，Handler 和 Looper - Jia Cheng">
    

    
      
    

    

    
    


<link href='//cdn.bootcss.com/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/custom.css" />

  </head>

  
  <body class="post">
    <header class="masthead">
      <h1><a href="/">Jia Cheng</a></h1>

<p class="tagline">Yang Jiacheng&#39;s Home Page.</p>

      <nav class="menu">
        <input id="menu-check" type="checkbox" />
        <label id="menu-label" for="menu-check" class="unselectable">
          <span class="icon close-icon">✕</span>
          <span class="icon open-icon">☰</span>
          <span class="text">Menu</span>
        </label>
        <ul>
        
        
        <li><a href="/">Home</a></li>
        
        <li><a href="/post/">Blog</a></li>
        
        <li><a href="/about/">About</a></li>
        
        <li><a href="/categories/">Categories</a></li>
        
        <li><a href="/tags/">Tags</a></li>
        
        <li><a href="/index.xml">Subscribe</a></li>
        
        
        </ul>
      </nav>
    </header>

    <article class="main">
      <header class="title">
      
<h1>Android Thread，Handler 和 Looper</h1>

<h3>杨嘉程
  /  2017-06-09</h3>
<hr>


      </header>





<h2 id="概述">概述</h2>

<p>所有的 APP 启动的时候都会运行在同一个主线程中，也就是用户界面（UI）线程。
在同一进程下运行的所有组件都在主线程中运行。</p>

<p>但是在 UI 线程中智行耗时比较长的操作就会阻塞 UI 线程，而且，如果 UI 线程被阻塞超过五秒钟就会引起 ANR 。</p>

<p>耗时比较长的典型操作如数据库事物，文件下载，复杂的计算等，应该在后台线程获工作线程中完成。</p>

<blockquote>
<p>Android 中不能在后台线程或工作线程中直接与UI元素相互作用，于是使用 Handler 在 UI 线程和后台线程或工作线程之间进行通信。</p>
</blockquote>

<p>如果直接在 UI 线程之外的别的线程直接刷新 UI 组件，便会抛出『java.lang.RuntimeException:Cannot update UI from another thread』。</p>

<h2 id="messagequeue">MessageQueue</h2>

<p>MessageQueue 是 Android 维持的一个任务队列，这些任务会按顺序一个接一个执行。<!-- more -->
在 Android 中 Message 不能被直接加入到 MessageQueue 中，只能使用 Handler 的对象添加。</p>

<h2 id="handler">Handler</h2>

<p>Handler 负责产生 Message ，发送 Message 到 MessageQueue，以及处理从 MessageQueue 中弹出的 Message。每一个 Handler 都必须与一个 Looper 绑定。</p>

<h2 id="looper">Looper</h2>

<p>Looper 轮询 MessageQueue 中的下一个 Message，每当遇到一个 Message，便把 Message 传递给对应的 Handler 处理。
Android 中，除了 UI 线程以外，普通的线程默认情况下是不自带 Looper 的。想要通过 UI 线程与子线程通信需要在子线程内创建一个 Looper。开启 Looper 分三步走：</p>

<ol>
<li>判断是否已有 Looper 并 <code>Looper.prepare()</code></li>
<li>做一些准备工作(如实例化 Handler 等)</li>
<li>调用 Looper.loop()，线程进入阻塞态，等待处理 Message</li>
</ol>

<p>典型代码如下：</p>

<pre><code class="language-java">  class LooperThread extends Thread {
      public Handler mHandler;

      public void run() {
          Looper.prepare();

          mHandler = new Handler() {
              public void handleMessage(Message msg) {
                  // process incoming messages here
              }
          };

          Looper.loop();
      }
  }
  
</code></pre>

<blockquote>
<p>注意: 一个线程只能关联一个 Looper，于是也只能关联一个 MessageQueue。但是一个 Looper 可以关联多个 Handler，只是这些 Handler 向同一个 MessageQueue 中插入 Message。</p>

<p>如果多个线程尝试向一个特定的 Looper 发送 Message，所有这些线程将会被顺序处理。</p>
</blockquote>

<p>如果尝试为同一个线程建立第二个 Looper，便会导致『java.lang.RuntimeException:Only one Looper may be created per thread』</p>

<p><strong>Android 是怎么检查线程是否已经关联一个 Looper 的 ？</strong></p>

<p>调用 <code>Looper.prepare()</code>创建 Looper 时，会首先检查当前线程的 ThreadLocal，确保还没有关联 Looper ，只有检查通过之后，才会创建新的 Looper 并保存在 ThreadLocal。</p>


  <footer>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/post/2017/03/07/story-of-nickname/">『麦田与海浪』背后的故事</a></span>
  <span class="nav-next"><a href="/post/2017/06/23/2017-06-23/">关于共享单车的一些胡思乱想</a> &rarr;</span>
</nav>





<script src="//yihui.name/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script>

  



<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/tex.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



  
  <hr>
  <div class="copyright">&copy; 2012-2018 | <a href="https://cheng.netlify.com">Yang Jiacheng</a> | <a href="https://github.com/caelanyang">Github</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

